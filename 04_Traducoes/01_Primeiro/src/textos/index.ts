import * as fs from 'fs';
import * as path from 'path';

type Translation = typeof import('./idiomas/base.json');
type Langs = 'base' | 'en' | 'es' | 'fr' | 'ptBr' | 'ptPO';

//?????????????????????????????????????????????????????????????????????????????????
//? Variaveis exportadas
//?????????????????????????????????????????????????????????????????????????????????
let dicionario: Record<string, Translation>;

//?????????????????????????????????????????????????????????????????????????????????
//? Metodos exportados
//?????????????????????????????????????????????????????????????????????????????????
function loadDicionario(): Record<string, Translation> {
  const base = loadLangFile('base');
  const en = deepMerge(base, loadLangFile('en'));
  const es = deepMerge(base, loadLangFile('es'));
  const fr = deepMerge(base, loadLangFile('fr'));
  const ptBr = deepMerge(base, loadLangFile('ptBr'));
  const ptPO = deepMerge(ptBr, loadLangFile('ptPO'));

  dicionario = {
    en,
    es,
    fr,
    ptBr,
    ptPO,
  };
  return dicionario;
}

function recarregarDicionario() {
  // Limpa o cache do require para cada arquivo
  clearLangFileCache('en');
  clearLangFileCache('es');
  clearLangFileCache('fr');
  clearLangFileCache('ptBr');
  clearLangFileCache('ptPO');
  loadDicionario();
}

function validaVariavesContratoBase() {
  const base = loadLangFile('base');
  const langs: Langs[] = ['en', 'es', 'fr', 'ptBr'];
  const faltantes: Array<{ lang: Langs, key: string }> = [];
  for (const lang of langs) {
    const langData = loadLangFile(lang);
    const chavesFaltantes = verificaChavesFaltantes(base, langData);
    chavesFaltantes.forEach(key => faltantes.push({ lang, key }));

  }
  return faltantes;
}

function format(text: string, vars: Record<string, string | number>) {
  return text.replace(/{(\w+)}/g, (_, key) => vars[key] !== undefined ? String(vars[key]) : `{${key}}`);
}

//?????????????????????????????????????????????????????????????????????????????????
//? Metodos internos
//?????????????????????????????????????????????????????????????????????????????????
function loadLangFile(lang: Langs) {
  let filePath: string;
  if (lang === 'base') {
    filePath = path.join(__dirname, 'idiomas', 'base.json');
  } else {
    filePath = path.join(__dirname, 'idiomas', lang, 'translation.json');
  }
  return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
}

function clearLangFileCache(lang: string) {
  delete require.cache[require.resolve(path.join(__dirname, 'idiomas', lang, 'translation.json'))];
}

function verificaChavesFaltantes(base: any, compare: any, prefix: string = ''): string[] {
  let faltantes: string[] = [];
  for (const key of Object.keys(base)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    if (!(key in compare)) {
      faltantes.push(fullKey);
    } else if (typeof base[key] === 'object' && base[key] !== null) {
      faltantes = faltantes.concat(verificaChavesFaltantes(base[key], compare[key], fullKey));
    }
  }
  return faltantes;
}

function deepMerge(base: any, override: any): any {
  if (typeof base !== 'object' || base === null) return override ?? base;
  const result: any = Array.isArray(base) ? [...base] : { ...base };
  for (const key of Object.keys(base)) {
    result[key] = deepMerge(base[key], override?.[key]);
  }
  for (const key of Object.keys(override || {})) {
    if (!(key in base)) result[key] = override[key];
  }
  return result;
}

export {
  dicionario,
  loadDicionario,
  recarregarDicionario,
  format,
  validaVariavesContratoBase
};

